Перем ОбъектЗаполнения Экспорт;
Перем Зарплата Экспорт;
Перем НомДок Экспорт;

&НаСервере
Процедура ВыполнитьКомандуНаСервере(Перем_Объект,СсылкаНаОбъект) 
	
	СоздатьДокументВРабочейБазе(Перем_Объект,СсылкаНаОбъект,СсылкаНаОбъект.Зарплата);
	
КонецПроцедуры	

Процедура СоздатьДокументВРабочейБазе(Обработка,Объект, Зарплата) Экспорт
	Проведение = Истина;	
	Соединение = ПодключитьсяКРабочейБазе();	

	СоздатьДокументНачислениеЗарплатыРаботникам(Соединение, Зарплата, Объект, Проведение);
	Если Проведение = Истина Тогда
		СозданиеДокументаЗарплатаКВыплате(Соединение, Зарплата,Объект);
		СоздатьДокументЗарплатаКВыплатеОрганизаций(Соединение, Зарплата, Объект);
	КонецЕсли;
	
КонецПроцедуры 

Процедура СоздатьДокументНачислениеЗарплатыРаботникам(Соединение, Зарплата, Объект, Проведение) Экспорт
	
	Если Зарплата.Количество() > 0 Тогда
		ЗарплатаТЗ = Зарплата.Выгрузить();
		ЗарплатаТЗ.Колонки.ФизическоеЛицо.Имя = "Физлицо"; 
		ЗарплатаТЗ.Свернуть("Сотрудник, Физлицо ", "КВыплате");

		
	МенеджерНачислениеЗарплатыРаботникам = Соединение.Документы.НачислениеЗарплатыРаботникам;
	НачислениеЗарплатыРаботникам = МенеджерНачислениеЗарплатыРаботникам.СоздатьДокумент();
	
	НачислениеЗарплатыРаботникам.ПериодРегистрации = Объект.ПериодРегистрации;
	НачислениеЗарплатыРаботникам.Дата = Объект.Дата;
	НачислениеЗарплатыРаботникам.ВидОперации = Соединение.Перечисления.ВидыОперацийНачислениеЗарплатыРаботникамОрганизаций.ПолныйРасчет;
	КолОш = 0;
	N = 0;
	Для Каждого Строка Из ЗарплатаТЗ Цикл
		N = N + 1;
		СтрокаДокумента 					= НачислениеЗарплатыРаботникам.Удержания.Добавить();
		ФизЛицо = Соединение.Справочники.ФизическиеЛица.НайтиПоРеквизиту("СтраховойНомерПФР", Строка.Физлицо.СтраховойНомерПФР);
		Если Строка.Физлицо.ИНН = ФизЛицо.ИНН Тогда
		   	СтрокаДокумента.Физлицо 			= ФизЛицо;
		Иначе
		   	СтрокаДокумента.Физлицо 			= Соединение.Справочники.ФизическиеЛица.ПустаяСсылка();
			Сообщить("Строка № " + N + " Сотрудник " + Строка.ФизическоеЛицо.Наименование + " не подставится в документы! (Начисление зарплаты работникам, Зарплата к выплате организации)");
			КолОш = КолОш + 1;
		КонецЕсли;
		
		Если Объект.Организация.ИНН = Справочники.Организации.НайтиПоРеквизиту("ИНН","2463042026").ИНН  Тогда    //Объект.Организация = Справочники.Организации.НайтиПоКоду("000000001")
		   	СтрокаДокумента.ВидРасчета 		= Соединение.ПланыВидовРасчета.УправленческиеУдержания.НайтиПоКоду("00012");
		ИначеЕсли Объект.Организация = Справочники.Организации.НайтиПоКоду("000000010") Тогда	
		   	СтрокаДокумента.ВидРасчета 		= Соединение.ПланыВидовРасчета.УправленческиеУдержания.НайтиПоКоду("00014");
		ИначеЕсли Объект.Организация = Справочники.Организации.НайтиПоКоду("000000018") Тогда	
		   	СтрокаДокумента.ВидРасчета 		= Соединение.ПланыВидовРасчета.УправленческиеУдержания.НайтиПоКоду("00015");
		ИначеЕсли Объект.Организация = Справочники.Организации.НайтиПоКоду("000000015") Тогда	
		   	СтрокаДокумента.ВидРасчета 		= Соединение.ПланыВидовРасчета.УправленческиеУдержания.НайтиПоКоду("00016");
		КонецЕсли;
		СтрокаДокумента.ДатаНачала 		= НачалоМесяца(Объект.ПериодРегистрации);
		СтрокаДокумента.ДатаОкончания 	= КонецМесяца(Объект.ПериодРегистрации);
		СтрокаДокумента.Результат 		= Строка.КВыплате;
	КонецЦикла;	
	НачислениеЗарплатыРаботникам.Комментарий = ?(НЕ Объект.Подразделение.Ссылка.Пустая(), "Загружено обработкой " + ТекущаяДата() + " ##Подразделение: " + Объект.Подразделение + " из рег. базы",
	"Загружено обработкой " + ТекущаяДата());
	Если НачислениеЗарплатыРаботникам.Удержания.Количество() > 0 Тогда
			НачислениеЗарплатыРаботникам.Записать();
			Сообщить("Создан документ в рабочей базе ""Начисление заработной платы сотрудникам """ + НачислениеЗарплатыРаботникам.Номер + " Дата:" + НачислениеЗарплатыРаботникам.Дата);
	КонецЕсли;	
КонецЕсли;	
	
КонецПроцедуры

Процедура СозданиеДокументаЗарплатаКВыплате(Соединение, Зарплата,Объект) Экспорт
	Если Зарплата.Количество() > 0 Тогда 
		
		МенеджерЗарплатыКВыплате =  Соединение.Документы.ЗарплатаКВыплате;
		ЗарплатаКВыплате 		= МенеджерЗарплатыКВыплате.СоздатьДокумент();
		
		ЗарплатаКВыплате.Date = Объект.Дата;
		ЗарплатаКВыплате.Комментарий = "Загружено обработкой " + ТекущаяДата() + " Док. создается для сохранения нумерации док. Зарплата к выплате организации";
		
		ЗарплатаКВыплате.Записать();
		Сообщить("Создан документ в рабочей базе ""Зарплата к выплате """ + ЗарплатаКВыплате.Number + " Дата:" + ЗарплатаКВыплате.Date);
		
		НомДок = ЗарплатаКВыплате.Number;
		
	КонецЕсли;
КонецПроцедуры

Процедура СоздатьДокументЗарплатаКВыплатеОрганизаций(Соединение, Зарплата, Объект) Экспорт
	                                                                                                                      
	Если Зарплата.Количество() > 0 Тогда
		ЗарплатаТЗ = Зарплата.Выгрузить();
		ЗарплатаТЗ.Колонки.ФизическоеЛицо.Имя = "Физлицо";
		ЗарплатаТЗ.Колонки.Удалить("СтатьяРасходов");
		ЗарплатаТЗ.Колонки.Удалить("ДокументОснование");
		ЗарплатаТЗ.Итог("КВыплате");
		ЗарплатаТЗ.Свернуть("Сотрудник, Физлицо ", "КВыплате"); 
			
		                                                            
		МенеджерЗарплатыКВыплатеОрганизаций = Соединение.Документы.ЗарплатаКВыплатеОрганизаций;
		ЗарплатаКВыплатеОрганизаций 		= МенеджерЗарплатыКВыплатеОрганизаций.СоздатьДокумент();
		
		
		Если Объект.Организация.ИНН = "2463042026" Тогда  
			Префикс = "ТПК";
		ИначеЕсли Объект.Организация.ИНН = "2404017050" Тогда
			Префикс = "ЗИ";
		ИначеЕсли Объект.Организация.ИНН = "2463122151" Тогда
			Префикс = "ЗЭЛ";
		КонецЕсли;	
		Длина_Чис = 11 - СтрДлина(Префикс); 		
		
		ЗарплатаКВыплатеОрганизаций.ПериодРегистрации 		 = Объект.ПериодРегистрации;
		ЗарплатаКВыплатеОрганизаций.Number 					 = Префикс + Прав(НомДок,Длина_Чис); 
		ЗарплатаКВыплатеОрганизаций.Дата 					 = Объект.Дата;
		ЗарплатаКВыплатеОрганизаций.Организация 			 = Соединение.Справочники.Организации.НайтиПоРеквизиту("ИНН", Объект.Организация.ИНН);
		ЗарплатаКВыплатеОрганизаций.СпособВыплаты 			 = Соединение.Перечисления.СпособыВыплатыЗарплаты.ЧерезБанк;
		ЗарплатаКВыплатеОрганизаций.ПодразделениеОрганизации = Объект.Дата; 
		ЗарплатаКВыплатеОрганизаций.ВидДоходаИсполнительногоПроизводства = Соединение.Перечисления.ВидыДоходовИсполнительногоПроизводства.ЗарплатаВознаграждения;
		ЗарплатаКВыплатеОрганизаций.ДатаНачала 				 = НачалоМесяца(Объект.Дата);
		ЗарплатаКВыплатеОрганизаций.ДатаОкончания 			 = КонецМесяца(Объект.Дата);
		Если ТипЗнч(Объект) = Тип("ДокументСсылка.ВедомостьНаВыплатуЗарплатыВБанк") Тогда
			Если Объект.ЗарплатныйПроект.Банк.ИНН = "3232005484" Тогда  
				ЗарплатаКВыплатеОрганизаций.Банк 					 = Соединение.Справочники.Контрагенты.НайтиПоКоду("000021872");
			ИначеЕсли Объект.ЗарплатныйПроект.Банк.ИНН = "7707083893" Тогда
				ЗарплатаКВыплатеОрганизаций.Банк 					 = Соединение.Справочники.Контрагенты.НайтиПоКоду("000018686");
			ИначеЕсли Объект.ЗарплатныйПроект.Банк.ИНН = "7728168971" Тогда
				
				Если ЗарплатаТЗ[0].Физлицо.СтраховойНомерПФР = "123-247-369 35" Тогда
					ЗарплатаКВыплатеОрганизаций.Банк 					 = Соединение.Справочники.Контрагенты.НайтиПоКоду("000000645");
				ИначеЕсли ЗарплатаТЗ[0].Физлицо.СтраховойНомерПФР = "031-370-801 08" Тогда
					ЗарплатаКВыплатеОрганизаций.Банк 					 = Соединение.Справочники.Контрагенты.НайтиПоКоду("000014613");
				ИначеЕсли ЗарплатаТЗ[0].Физлицо.СтраховойНомерПФР = "075-160-602 46" Тогда
					ЗарплатаКВыплатеОрганизаций.Банк 					 = Соединение.Справочники.Контрагенты.НайтиПоКоду("000021189");	
				КонецЕсли;	 
				
			ИначеЕсли Объект.ЗарплатныйПроект.Банк.ИНН = "7744001497" Тогда
				ЗарплатаКВыплатеОрганизаций.Банк 					 = Соединение.Справочники.Контрагенты.НайтиПоКоду("000008732");	
			КонецЕсли;
			
		Иначе
			
			Если Объект.Банк.ИНН = "3232005484" Тогда  
				ЗарплатаКВыплатеОрганизаций.Банк 					 = Соединение.Справочники.Контрагенты.НайтиПоКоду("000021872");
			ИначеЕсли Объект.Банк.ИНН = "7707083893" Тогда
				ЗарплатаКВыплатеОрганизаций.Банк 					 = Соединение.Справочники.Контрагенты.НайтиПоКоду("000018686");
			ИначеЕсли Объект.Банк.ИНН = "7728168971" Тогда
				
				Если ЗарплатаТЗ[0].Физлицо.СтраховойНомерПФР = "123-247-369 35" Тогда
					ЗарплатаКВыплатеОрганизаций.Банк 					 = Соединение.Справочники.Контрагенты.НайтиПоКоду("000000645");
				ИначеЕсли ЗарплатаТЗ[0].Физлицо.СтраховойНомерПФР = "031-370-801 08" Тогда
					ЗарплатаКВыплатеОрганизаций.Банк 					 = Соединение.Справочники.Контрагенты.НайтиПоКоду("000014613");
				ИначеЕсли ЗарплатаТЗ[0].Физлицо.СтраховойНомерПФР = "075-160-602 46" Тогда
					ЗарплатаКВыплатеОрганизаций.Банк 					 = Соединение.Справочники.Контрагенты.НайтиПоКоду("000021189");	
				КонецЕсли;	 
				
			ИначеЕсли Объект.Банк.ИНН = "7744001497" Тогда
				ЗарплатаКВыплатеОрганизаций.Банк 					 = Соединение.Справочники.Контрагенты.НайтиПоКоду("000008732");	
			КонецЕсли;
			
		КонецЕсли;
		ЗарплатаКВыплатеОрганизаций.СуммаДокумента           = Объект.СуммаПоДокументу;  
		
		Если Объект.СпособВыплаты = Справочники.СпособыВыплатыЗарплаты.НайтиПоНаименованию("Аванс") Тогда
			ХарактерВыплаты		 								 = Соединение.Перечисления.ХарактерВыплатыЗарплаты.АвансЗаПервуюПоловинуМесяца;
		ИначеЕсли Объект.СпособВыплаты = Справочники.СпособыВыплатыЗарплаты.НайтиПоНаименованию("Зарплата за месяц") Тогда
			ХарактерВыплаты		 								 = Соединение.Перечисления.ХарактерВыплатыЗарплаты.Зарплата;
		ИначеЕсли Объект.СпособВыплаты = Справочники.СпособыВыплатыЗарплаты.НайтиПоНаименованию("Больничные листы") Тогда
			ХарактерВыплаты		 								 = Соединение.Перечисления.ХарактерВыплатыЗарплаты.ПоБольничнымЛистам;
		ИначеЕсли Объект.СпособВыплаты = Справочники.СпособыВыплатыЗарплаты.НайтиПоНаименованию("Отпуска") Тогда
			ХарактерВыплаты		 								 = Соединение.Перечисления.ХарактерВыплатыЗарплаты.Отпускные;
		ИначеЕсли Объект.СпособВыплаты = Справочники.СпособыВыплатыЗарплаты.НайтиПоНаименованию("Премии") Тогда
			ХарактерВыплаты		 								 = Соединение.Перечисления.ХарактерВыплатыЗарплаты.Премии;
		ИначеЕсли Объект.СпособВыплаты = Справочники.СпособыВыплатыЗарплаты.НайтиПоНаименованию("Увольнения") Тогда
			ХарактерВыплаты		 								 = Соединение.Перечисления.ХарактерВыплатыЗарплаты.РасчетПриУвольнении;
		ИначеЕсли Объект.СпособВыплаты = Справочники.СпособыВыплатыЗарплаты.НайтиПоНаименованию("Разовые начисления") Тогда
			ХарактерВыплаты		 								 = Соединение.Перечисления.ХарактерВыплатыЗарплаты.ПрочиеРазовыеНачисления;
		ИначеЕсли Объект.СпособВыплаты = Справочники.СпособыВыплатыЗарплаты.НайтиПоНаименованию("Командировки") Тогда
			ХарактерВыплаты		 								 = Соединение.Перечисления.ХарактерВыплатыЗарплаты.Командировочные;		
		КонецЕсли;
	
		ЗарплатаКВыплатеОрганизаций.ХарактерВыплаты          	= ХарактерВыплаты;
		Для Каждого Строка Из ЗарплатаТЗ Цикл
			СтрокаДокумента 									= ЗарплатаКВыплатеОрганизаций.Зарплата.Добавить();
			
			ФизЛицо 					= Соединение.Справочники.ФизическиеЛица.НайтиПоРеквизиту("СтраховойНомерПФР", Строка.ФизЛицо.СтраховойНомерПФР);
			СтрокаДокумента.Физлицо 	= ?(Строка.Физлицо.ИНН = ФизЛицо.ИНН, ФизЛицо, Соединение.Справочники.ФизическиеЛица.ПустаяСсылка());
			СтрокаДокумента.Сумма 		= Строка.КВыплате;
			СтрокаДокумента.Начислено 	= Строка.КВыплате;
		КонецЦикла;
		
		
	
		ЗарплатаКВыплатеОрганизаций.Комментарий = ?(НЕ Объект.Подразделение.Ссылка.Пустая(), "Загружено обработкой " + ТекущаяДата() + " ##Подразделение: " + Объект.Подразделение + " из рег. базы",
		"Загружено обработкой " + ТекущаяДата());
		Если ЗарплатаКВыплатеОрганизаций.Зарплата.Количество() > 0 Тогда
			ЗарплатаКВыплатеОрганизаций.Записать();
			Сообщить("Создан документ в рабочей базе ""Зарплата к выплате организаций """ + ЗарплатаКВыплатеОрганизаций.Номер + " Дата:" + ЗарплатаКВыплатеОрганизаций.Дата);
		КонецЕсли;	
		
	КонецЕсли;
КонецПроцедуры

Функция ПодключитьсяКРабочейБазе() Экспорт 
	
	АдресПриемника = "Srvr="""";Ref="""";"; //Просто данные подключения. На пример кода не влияют
	connection = Неопределено;
	Попытка
		БазаИсточник = Новый COMObject("V83.COMConnector.1");     //"V83.COMConnector_8.3.20.1590"
		connection = БазаИсточник.Connect(АдресПриемника + "Usr=""" + "Voyager" + """;Pwd=""" + "Voyager123" + """;");
	Исключение
		ОписаниеОшибки = ОписаниеОшибки();
		Если Найти(ОписаниеОшибки, "Пользователь ИБ не идентифицирован") тогда
	         СпроситьИмяИПароль = Истина;
		Иначе
			//Предупреждение("" + ОписаниеОшибки, 60);
			//Возврат ;
		КонецЕсли;
	КонецПопытки;
	
	Возврат connection;
КонецФункции


	
&НаКлиенте
Процедура ВыполнитьКоманду(ИдентификаторКоманды, ОбъектыНазначенияМассив) Экспорт
	Перем_Объект = ЭтаФорма.Объект;
	СсылкаНаОбъект = ВладелецФормы.Объект.Ссылка;                        
	//СсылкаНаОбъект = ЭтаФорма.Объект.СсылкаНаОбъект; // ДЛЯ ОТЛАДКИ                                     
	ВыполнитьКомандуНаСервере(Перем_Объект,СсылкаНаОбъект);  	
КонецПроцедуры
