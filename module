//Процедура в модуле формы документа
Процедура НаличиеКартыМИРПриИзменении(Элемент)
	МодульИАО.РеестрСведенийВФССОПособияхПоНетрудоспособности_НаличиеКартыМИРПриИзменении(ЭтотОбъект,Элемент);
КонецПроцедуры

//Все, что ниже - это код из общего модуля
#Область РеестрСведенийВФССОПособияхПоНетрудоспособности

Процедура РеестрСведенийВФССОПособияхПоНетрудоспособности_НаличиеКартыМИРПриИзменении(Объект,Элемент ) Экспорт
	
	ПривязкаНомераКартыМИР(Объект, Элемент);
	
КонецПроцедуры

#КонецОбласти

#Область ПривязкаНомераКартыМИР

	Процедура ПривязкаНомераКартыМИР (Объект,Элемент,ТекущиеДанные = неопределено)	
	
	Если НЕ (ТипЗнч(Объект) = Тип("ДокументОбъект.РеестрСведенийВФССОЕжемесячныхПособияхПоУходу") 
		ИЛИ ТипЗнч(Объект)= Тип("ДокументОбъект.РеестрСведенийВФССОПособияхПоНетрудоспособности") 
		ИЛИ ТипЗнч(Объект)= Тип("ДокументОбъект.РеестрСведенийВФССОПособияхПриРожденииРебенка") )Тогда
		
		Если НЕ Элемент.Значение = ЛОЖЬ Тогда                
			      
			Запрос = Новый Запрос;                                                     
			Запрос.Текст = 
			"ВЫБРАТЬ
			|	ИАО_НомераКартМИРСрезПоследних.НомерКартыМИР
			|ИЗ
			|	РегистрСведений.ИАО_НомераКартМИР.СрезПоследних(&Дата, ) КАК ИАО_НомераКартМИРСрезПоследних
			|ГДЕ
			|	ИАО_НомераКартМИРСрезПоследних.Сотрудник = &Сотрудник
			|	И ИАО_НомераКартМИРСрезПоследних.Организация = &Организация
			|	И ИАО_НомераКартМИРСрезПоследних.Банк = &Банк";
			
			Запрос.УстановитьПараметр("Сотрудник", ?(Объект.Метаданные() =  Метаданные.Документы.СведенияОЗастрахованныхЛицахФСС,ТекущиеДанные.Сотрудник,Объект.Сотрудник));
			Запрос.УстановитьПараметр("Организация", Объект.Организация);
			Запрос.УстановитьПараметр("Банк", ?(Объект.Метаданные() =  Метаданные.Документы.СведенияОЗастрахованныхЛицахФСС,ТекущиеДанные.Банк,Объект.Банк));
			Запрос.УстановитьПараметр("Дата", Объект.Дата);
			
			РезультатЗапроса = Запрос.Выполнить().Выгрузить();
			
			Если НЕ РезультатЗапроса.Количество() = 0 Тогда
				
				Если Объект.Метаданные() =  Метаданные.Документы.СведенияОЗастрахованныхЛицахФСС тогда
					ТекущиеДанные.НомерКартыМир = РезультатЗапроса[0].НомерКартыМИР; 
				Иначе
					Объект.НомерКартыМир = РезультатЗапроса[0].НомерКартыМИР;
				КонецЕсли;
				
			Иначе
				
				Режим = РежимДиалогаВопрос.ОК;
				
				Ответ = Вопрос("В регистре ""Номера карт МИР"" не заполнены все поля или дата документа меньше даты запииси в регистре для этого сотрудника. Проверьте данные и повторите попытку.", Режим,0);
				
				Элемент.Значение = ЛОЖЬ;
				
				Отказ = Истина;
				
				Если Объект.Метаданные() =  Метаданные.Документы.СведенияОЗастрахованныхЛицахФСС тогда
					ТекущиеДанные.НомерКартыМир =  ""; 
				Иначе
					Объект.НомерКартыМир = "";
				КонецЕсли;
				
				Возврат;
				
			КонецЕсли;	
			
		КонецЕсли;
		
	Иначе
		
		ТЗ = Объект.РаботникиОрганизации.Выгрузить();
		ТЗ.Свернуть("Сотрудник","Банк");
		
		Если НЕ Элемент.Значение = ЛОЖЬ Тогда                
			
			Запрос = Новый Запрос;                                                     
			Запрос.Текст = 
			"ВЫБРАТЬ
			|	ИАО_НомераКартМИРСрезПоследних.НомерКартыМИР
			|ИЗ
			|	РегистрСведений.ИАО_НомераКартМИР.СрезПоследних(&Дата, ) КАК ИАО_НомераКартМИРСрезПоследних
			|ГДЕ
			|	ИАО_НомераКартМИРСрезПоследних.Сотрудник = &Сотрудник
			|	И ИАО_НомераКартМИРСрезПоследних.Организация = &Организация
			|	И ИАО_НомераКартМИРСрезПоследних.Банк = &Банк";
			
			Запрос.УстановитьПараметр("Сотрудник", ТЗ.ВыгрузитьКолонку("Сотрудник")[0]);
			Запрос.УстановитьПараметр("Организация", Объект.Организация);
			Запрос.УстановитьПараметр("Банк", ТЗ.ВыгрузитьКолонку("Банк")[0]);
			Запрос.УстановитьПараметр("Дата", Объект.Дата);
			
			РезультатЗапроса = Запрос.Выполнить().Выгрузить();
			
			Если НЕ РезультатЗапроса.Количество() = 0 Тогда
				
				Объект.РаботникиОрганизации[0].НомерКартыМИР = РезультатЗапроса[0].НомерКартыМИР;
				
			Иначе
				
				Режим = РежимДиалогаВопрос.ОК;
				
				Ответ = Вопрос("В регистре ""Номера карт МИР"" не заполнены все поля или дата документа меньше даты запииси в регистре для этого сотрудника. Проверьте данные и повторите попытку.", Режим,0);
				
				Элемент.Значение = ЛОЖЬ;
				
				Отказ = Истина;
				
				Объект.РаботникиОрганизации[0].НомерКартыМИР = "";
				
				Возврат;
				
			КонецЕсли;	
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры	

#КонецОбласти
